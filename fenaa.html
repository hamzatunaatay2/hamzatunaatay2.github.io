<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeri Baronu: Drift Edition</title>
    <style>
        :root { --neon: #00f2ff; --pink: #ff007f; --gold: #ffd700; --dark: #111; }
        body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; }
        
        /* UI KATMANI */
        #hud { position: fixed; top: 0; width: 100%; height: 50px; display: flex; align-items: center; justify-content: space-around; background: #000; z-index: 9999; border-bottom: 2px solid var(--neon); box-shadow: 0 0 15px var(--neon); }
        .stat { font-size: 16px; font-weight: bold; }
        .stat span { color: var(--gold); }

        /* OYUN D√úZENƒ∞ */
        #game { display: grid; grid-template-columns: 300px 1fr; height: 100vh; padding-top: 50px; }
        
        /* MEN√ú */
        #sidebar { 
            background: #0a0a0a; border-right: 1px solid #333; padding: 15px; 
            z-index: 5000; overflow-y: auto; box-shadow: 5px 0 20px #000;
        }
        .btn { 
            background: #222; border: 1px solid #444; color: #fff; padding: 12px; 
            width: 100%; margin-bottom: 8px; cursor: pointer; font-weight: bold; 
            text-align: left; transition: 0.2s; position: relative; z-index: 5001; 
        }
        .btn:hover { background: #333; border-color: var(--neon); color: var(--neon); padding-left: 20px; }
        .btn.danger { border-color: var(--pink); color: var(--pink); }
        .btn.danger:hover { background: var(--pink); color: #fff; }

        /* 3D ALAN */
        #viewport { position: relative; background: #333; width: 100%; height: 100%; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; outline: none; }
        
        /* HIZ G√ñSTERGESƒ∞ */
        #speedometer {
            position: absolute; bottom: 30px; left: 30px; 
            font-size: 40px; font-weight: 900; font-family: sans-serif; font-style: italic;
            color: #fff; text-shadow: 0 0 10px var(--neon);
            z-index: 100; pointer-events: none;
        }

        /* OFƒ∞S ARAY√úZ√ú */
        #office-layer { 
            position: absolute; inset: 0; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 10; pointer-events: none; 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
        }
        .dialog-container {
            pointer-events: auto; background: rgba(0,0,0,0.9); padding: 25px; 
            border: 2px solid var(--neon); border-radius: 10px; text-align: center; 
            width: 90%; max-width: 500px; box-shadow: 0 0 50px rgba(0,242,255,0.2);
        }
        .action-row { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }

        /* Lƒ∞STELER */
        .car-item { background: #151515; padding: 10px; border-left: 4px solid var(--gold); margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .sell-btn { background: var(--gold); border: none; padding: 5px 10px; font-weight: bold; cursor: pointer; }

        /* Bƒ∞LDƒ∞Rƒ∞M */
        #notif { position: fixed; top: 70px; right: -300px; background: var(--pink); color: #fff; padding: 15px; z-index: 10000; font-weight: bold; transition: 0.3s; border-left: 5px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #notif.active { right: 20px; }

        /* MOBƒ∞L UYUM */
        @media (max-width: 768px) {
            #game { grid-template-columns: 1fr; grid-template-rows: 40% 60%; }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="hud">
    <div class="stat">üíµ <span id="money">0</span>‚Ç∫</div>
    <div class="stat">üëë ƒ∞tibar: <span id="rep">0</span></div>
    <button onclick="saveGame()" style="background:#333; color:#fff; border:1px solid #555; cursor:pointer;">KAYDET</button>
</div>

<div id="game">
    <div id="sidebar">
        <h4 style="color:var(--neon); margin-top:0;">GALERƒ∞ Y√ñNETƒ∞Mƒ∞</h4>
        <button class="btn" onclick="switchMode('office')">ü§ù M√ú≈ûTERƒ∞ G√ñR√ú≈ûMESƒ∞</button>
        <button class="btn" onclick="startDrive()">üèéÔ∏è TEST S√úR√ú≈û√úNE √áIK</button>
        <button class="btn danger" onclick="visitImam()">üïå CUMA NAMAZI (Enerji)</button>
        
        <hr style="border-color:#333; margin: 20px 0;">
        <h4 style="color:var(--gold);">GARAJDAKƒ∞ ARA√áLAR</h4>
        <div id="garage-list">Y√ºkleniyor...</div>
    </div>

    <div id="viewport">
        <canvas id="stage"></canvas>
        <div id="speedometer" class="hidden">0 <span style="font-size:20px">KM/H</span></div>

        <div id="office-layer">
            <div class="dialog-container">
                <div style="font-size:60px; margin-bottom:10px;">üë§</div>
                <div id="npc-text" style="font-size:18px; line-height:1.5;">"M√º≈üteri bekleniyor..."</div>
                <div class="action-row" id="trade-btns"></div>
            </div>
        </div>
    </div>
</div>

<div id="notif">Bildirim</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    // --- OYUN VERƒ∞LERƒ∞ ---
    const CAR_MODELS = [
        { name: "Tofa≈ü ≈ûahin", price: 200000, color: 0xffffff },
        { name: "BMW E30", price: 450000, color: 0xaa0000 },
        { name: "Honda S2000", price: 900000, color: 0x333333 },
        { name: "VW Passat", price: 1500000, color: 0x000000 },
        { name: "Mercedes G63", price: 6000000, color: 0x222222 }
    ];

    let state = { money: 500000, rep: 10, garage: [] };
    let currentOffer = null;
    let isDriving = false;

    // --- BA≈ûLANGI√á ---
    window.onload = function() {
        if(localStorage.getItem('mafiaSaveV3')) {
            state = JSON.parse(localStorage.getItem('mafiaSaveV3'));
            notify("Kayƒ±t y√ºklendi patron.");
        }
        init3D();
        updateUI();
        generateCustomer();
    };

    function saveGame() {
        localStorage.setItem('mafiaSaveV3', JSON.stringify(state));
        notify("Oyun kaydedildi!");
    }

    function notify(msg) {
        const n = document.getElementById('notif');
        n.innerText = msg;
        n.classList.add('active');
        setTimeout(() => n.classList.remove('active'), 3000);
    }

    // --- ARAY√úZ FONKSƒ∞YONLARI ---
    function updateUI() {
        document.getElementById('money').innerText = state.money.toLocaleString('tr-TR');
        document.getElementById('rep').innerText = state.rep;

        const list = document.getElementById('garage-list');
        list.innerHTML = "";
        if(state.garage.length === 0) list.innerHTML = "<div style='color:#666; font-size:12px;'>Garaj bo≈ü, yaya kaldƒ±n.</div>";
        
        state.garage.forEach((car, i) => {
            list.innerHTML += `
            <div class="car-item">
                <div>
                    <div style="color:#fff; font-weight:bold">${car.name}</div>
                    <div style="color:#888; font-size:11px;">Alƒ±≈ü: ${car.boughtPrice.toLocaleString()}‚Ç∫</div>
                </div>
                <button class="sell-btn" onclick="sellCar(${i})">SAT</button>
            </div>`;
        });
    }

    function switchMode(mode) {
        const office = document.getElementById('office-layer');
        const speedo = document.getElementById('speedometer');
        
        if(mode === 'office') {
            office.classList.remove('hidden');
            speedo.classList.add('hidden');
            isDriving = false;
            resetCameraForOffice();
            generateCustomer();
        }
    }

    function startDrive() {
        if(state.garage.length === 0) {
            notify("Karde≈üim araban yok! √ñnce araba al.");
            return;
        }
        document.getElementById('office-layer').classList.add('hidden');
        document.getElementById('speedometer').classList.remove('hidden');
        
        // Rastgele bir araba rengi se√ß (garajdaki ilk araba rengi sim√ºlasyonu)
        updateCarColor(state.garage[0].name);
        
        isDriving = true;
        resetCar();
        document.getElementById('stage').focus();
    }

    // --- Tƒ∞CARET ---
    function generateCustomer() {
        const base = CAR_MODELS[Math.floor(Math.random() * CAR_MODELS.length)];
        const price = Math.floor(base.price * (0.8 + Math.random() * 0.4));
        currentOffer = { name: base.name, price: price };
        
        document.getElementById('npc-text').innerText = 
            `"Selamun aleyk√ºm. Elimde √ßi√ßek gibi bir ${base.name} var. ${price.toLocaleString()}‚Ç∫ istiyorum. Ne dersin?"`;
            
        document.getElementById('trade-btns').innerHTML = `
            <button class="btn" style="width:auto; background:var(--neon); color:#000;" onclick="trade('buy')">SATIN AL</button>
            <button class="btn danger" style="width:auto;" onclick="trade('reject')">ƒ∞STEMEM</button>
        `;
    }

    function trade(action) {
        if(action === 'buy') {
            if(state.money >= currentOffer.price) {
                state.money -= currentOffer.price;
                state.garage.push({ name: currentOffer.name, boughtPrice: currentOffer.price });
                notify("Hayƒ±rlƒ± olsun! Anahtar cebinde.");
            } else notify("Paran yetmiyor kral.");
        } else notify("M√º≈üteri gitti.");
        
        updateUI();
        generateCustomer();
    }

    function sellCar(idx) {
        const car = state.garage[idx];
        const sellPrice = Math.floor(car.boughtPrice * (1.1 + Math.random() * 0.25));
        if(confirm(`${car.name} aracƒ±nƒ± ${sellPrice.toLocaleString()}‚Ç∫ fiyatƒ±na okutalƒ±m mƒ±?`)) {
            state.money += sellPrice;
            state.garage.splice(idx, 1);
            state.rep += 5;
            notify(`${sellPrice.toLocaleString()}‚Ç∫ kazandƒ±n!`);
            updateUI();
        }
    }

    function visitImam() {
        state.rep += 2;
        notify("Huzur buldun. ƒ∞tibarƒ±n arttƒ±.");
        updateUI();
    }

    // --- 3D D√úNYA & Fƒ∞Zƒ∞K MOTORU ---
    let scene, camera, renderer;
    let playerCar, carBodyMesh, carLights;
    let velocity = { x:0, z:0 }, speed = 0, angle = 0;
    let keys = {};

    function init3D() {
        const canvas = document.getElementById('stage');
        renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        scene = new THREE.Scene();
        // ƒ∞STEK: Beyazƒ±msƒ±/Gri Sisli Arka Plan
        scene.background = new THREE.Color(0xbdc3c7);
        scene.fog = new THREE.Fog(0xbdc3c7, 10, 80);

        camera = new THREE.PerspectiveCamera(60, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        
        // I≈üƒ±klandƒ±rma
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
        scene.add(hemiLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(50, 100, 50);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048; 
        dirLight.shadow.mapSize.height = 2048;
        dirLight.shadow.camera.near = 0.5;
        dirLight.shadow.camera.far = 500;
        dirLight.shadow.camera.left = -100;
        dirLight.shadow.camera.right = 100;
        dirLight.shadow.camera.top = 100;
        dirLight.shadow.camera.bottom = -100;
        scene.add(dirLight);

        // Zemin (Asfalt)
        const groundGeo = new THREE.PlaneGeometry(2000, 2000);
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.8 });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Yol √áizgileri (Basit Grid)
        const grid = new THREE.GridHelper(2000, 200, 0xffffff, 0x555555);
        grid.position.y = 0.1;
        scene.add(grid);

        createEnvironment();
        createDetailedCar();

        // Klavye
        window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
        window.addEventListener('resize', () => {
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        });

        animate();
    }

    function createEnvironment() {
        // ƒ∞STEK: Sokak Lambalarƒ±
        const poleGeo = new THREE.CylinderGeometry(0.2, 0.2, 8);
        const poleMat = new THREE.MeshStandardMaterial({color: 0x222});
        
        for(let i=0; i<40; i++) { // Yol boyunca lambalar
            const z = (i - 20) * 40;
            const xLeft = -15;
            const xRight = 15;
            
            // Lamba Direƒüi
            const poleL = new THREE.Mesh(poleGeo, poleMat);
            poleL.position.set(xLeft, 4, z);
            poleL.castShadow = true;
            scene.add(poleL);

            // I≈üƒ±k Kaynaƒüƒ± (Spot)
            const spotL = new THREE.SpotLight(0xffaa00, 1, 30, 0.5, 0.5, 1);
            spotL.position.set(xLeft, 8, z);
            spotL.target.position.set(0, 0, z);
            scene.add(spotL);
            scene.add(spotL.target);

            // Saƒü taraf i√ßin de yapalƒ±m
            if(Math.random() > 0.5) {
                const poleR = new THREE.Mesh(poleGeo, poleMat);
                poleR.position.set(xRight, 4, z);
                scene.add(poleR);
            }
        }

        // Binalar (Kutular)
        const buildingGeo = new THREE.BoxGeometry(1,1,1);
        const buildingMat = new THREE.MeshStandardMaterial({color: 0x888888});
        
        for(let i=0; i<100; i++) {
            const h = Math.random()*20 + 5;
            const w = Math.random()*10 + 5;
            const b = new THREE.Mesh(buildingGeo, buildingMat);
            
            const dist = 30 + Math.random() * 50; // Yoldan uzak olsun
            const side = Math.random() > 0.5 ? 1 : -1;
            
            b.position.set(side * dist, h/2, (Math.random()-0.5)*800);
            b.scale.set(w, h, w);
            b.castShadow = true;
            b.receiveShadow = true;
            scene.add(b);
        }
    }

    function createDetailedCar() {
        playerCar = new THREE.Group();

        // 1. G√∂vde (Alt Kƒ±sƒ±m)
        const chassisGeo = new THREE.BoxGeometry(2.2, 0.6, 5);
        const chassisMat = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.7, roughness: 0.2 });
        carBodyMesh = new THREE.Mesh(chassisGeo, chassisMat);
        carBodyMesh.position.y = 0.6;
        carBodyMesh.castShadow = true;
        playerCar.add(carBodyMesh);

        // 2. Kabin (√úst Kƒ±sƒ±m - Camlar)
        const cabinGeo = new THREE.BoxGeometry(1.9, 0.5, 2.5);
        const cabinMat = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.0 });
        const cabin = new THREE.Mesh(cabinGeo, cabinMat);
        cabin.position.set(0, 1.15, -0.3);
        cabin.castShadow = true;
        playerCar.add(cabin);

        // 3. Tekerlekler
        const wheelGeo = new THREE.CylinderGeometry(0.4, 0.4, 0.4, 16);
        const wheelMat = new THREE.MeshStandardMaterial({ color: 0x222 });
        const positions = [
            {x: 1.1, z: 1.5}, {x: -1.1, z: 1.5}, // √ñn
            {x: 1.1, z: -1.5}, {x: -1.1, z: -1.5} // Arka
        ];
        positions.forEach(pos => {
            const w = new THREE.Mesh(wheelGeo, wheelMat);
            w.rotation.z = Math.PI / 2;
            w.position.set(pos.x, 0.4, pos.z);
            w.castShadow = true;
            playerCar.add(w);
        });

        // 4. ƒ∞STEK: Arabanƒ±n I≈üƒ±klarƒ± (Farlar)
        // √ñn Farlar (G√∂rsel)
        const headLightGeo = new THREE.BoxGeometry(0.4, 0.2, 0.1);
        const headLightMat = new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0xffffff, emissiveIntensity: 2 });
        
        const hlLeft = new THREE.Mesh(headLightGeo, headLightMat);
        hlLeft.position.set(-0.7, 0.7, 2.5);
        playerCar.add(hlLeft);

        const hlRight = new THREE.Mesh(headLightGeo, headLightMat);
        hlRight.position.set(0.7, 0.7, 2.5);
        playerCar.add(hlRight);

        // √ñn Farlar (Ger√ßek I≈üƒ±k Kaynaƒüƒ±)
        carLights = new THREE.Group();
        const spotL = new THREE.SpotLight(0xffffff, 2, 60, 0.6, 0.5, 1);
        spotL.position.set(-0.7, 0.7, 2.6);
        spotL.target.position.set(-0.7, 0, 20);
        carLights.add(spotL);
        carLights.add(spotL.target);

        const spotR = new THREE.SpotLight(0xffffff, 2, 60, 0.6, 0.5, 1);
        spotR.position.set(0.7, 0.7, 2.6);
        spotR.target.position.set(0.7, 0, 20);
        carLights.add(spotR);
        carLights.add(spotR.target);
        
        playerCar.add(carLights);

        // Arka Stoplar
        const tailGeo = new THREE.BoxGeometry(0.4, 0.2, 0.1);
        const tailMat = new THREE.MeshStandardMaterial({ color: 0xff0000, emissive: 0xff0000, emissiveIntensity: 1 });
        const tlLeft = new THREE.Mesh(tailGeo, tailMat);
        tlLeft.position.set(-0.7, 0.7, -2.5);
        playerCar.add(tlLeft);
        const tlRight = new THREE.Mesh(tailGeo, tailMat);
        tlRight.position.set(0.7, 0.7, -2.5);
        playerCar.add(tlRight);

        scene.add(playerCar);
    }

    function updateCarColor(modelName) {
        // Modele g√∂re renk bul
        const carData = CAR_MODELS.find(c => c.name === modelName) || CAR_MODELS[0];
        if(carBodyMesh) {
            carBodyMesh.material.color.setHex(carData.color || 0xffd700);
        }
    }

    function resetCar() {
        playerCar.position.set(0, 0.1, 0);
        playerCar.rotation.set(0, 0, 0);
        velocity = {x:0, z:0};
        speed = 0;
        angle = 0;
    }

    function resetCameraForOffice() {
        camera.position.set(0, 5, 10);
        camera.lookAt(0,0,0);
    }

    // --- Fƒ∞Zƒ∞K MOTORU LOOP ---
    function animate() {
        requestAnimationFrame(animate);

        if(isDriving) {
            // 1. ƒ∞vmelenme
            if(keys['w']) speed += 0.02;
            else if(keys['s']) speed -= 0.03;
            else speed *= 0.96; // S√ºrt√ºnme (gazƒ± bƒ±rakƒ±nca yava≈ülar)

            // Max hƒ±z limiti
            speed = Math.max(Math.min(speed, 1.8), -0.6);

            // 2. D√∂n√º≈ü (Hƒ±zlandƒ±k√ßa daha yava≈ü d√∂ner - Stabilite)
            if(Math.abs(speed) > 0.1) {
                const turnSpeed = 0.04;
                if(keys['a']) angle += turnSpeed * (speed > 0 ? 1 : -1);
                if(keys['d']) angle -= turnSpeed * (speed > 0 ? 1 : -1);
            }

            // 3. Drift Mantƒ±ƒüƒ± (Vekt√∂r ƒ∞nterpolasyonu)
            // Arabanƒ±n baktƒ±ƒüƒ± y√∂ne doƒüru hedef hƒ±z vekt√∂r√ºn√º hesapla
            const targetVX = Math.sin(angle) * speed;
            const targetVZ = Math.cos(angle) * speed;

            // Mevcut hƒ±z vekt√∂r√ºn√º, hedef vekt√∂re "yava≈ü√ßa" e≈üitle (Lerp)
            // Bu sayede araba d√∂ner ama hƒ±zƒ± hemen d√∂nmez -> Kayma Efekti
            const driftFactor = 0.1; // Ne kadar d√º≈ü√ºkse o kadar √ßok kayar
            velocity.x += (targetVX - velocity.x) * driftFactor;
            velocity.z += (targetVZ - velocity.z) * driftFactor;

            // 4. Pozisyon G√ºncelleme
            playerCar.position.x += velocity.x;
            playerCar.position.z += velocity.z;
            playerCar.rotation.y = angle;

            // Araba sallanma efekti (Hƒ±za baƒülƒ±)
            playerCar.rotation.z = (velocity.x - targetVX) * -2; // D√∂n√º≈üte yana yatma
            playerCar.rotation.x = speed * -0.05; // Hƒ±zlanƒ±nca arkaya yatma

            // Kamera Takibi (Yumu≈üak)
            const camDist = 12;
            const camHeight = 7;
            const targetCamPos = {
                x: playerCar.position.x - Math.sin(angle) * camDist,
                y: playerCar.position.y + camHeight,
                z: playerCar.position.z - Math.cos(angle) * camDist
            };
            
            camera.position.x += (targetCamPos.x - camera.position.x) * 0.1;
            camera.position.y += (targetCamPos.y - camera.position.y) * 0.1;
            camera.position.z += (targetCamPos.z - camera.position.z) * 0.1;
            camera.lookAt(playerCar.position);

            // Hƒ±z g√∂stergesi
            document.getElementById('speedometer').innerHTML = Math.floor(Math.abs(speed) * 120) + " <span style='font-size:20px'>KM/H</span>";

        } else {
            // Ofis Modu: Kamera yava≈ü√ßa d√∂ns√ºn
            const time = Date.now() * 0.0005;
            camera.position.x = Math.sin(time) * 15;
            camera.position.z = Math.cos(time) * 15;
            camera.lookAt(0, 0.5, 0);
        }

        renderer.render(scene, camera);
    }
</script>
</body>
</html>
