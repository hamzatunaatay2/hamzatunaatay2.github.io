<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Tuna Galeri: Traffic & Trade</title>
    <style>
        :root { --neon: #00f2ff; --pink: #ff007f; --gold: #ffd700; --red: #ff4757; --road: #1a1a1a; }
        body { margin: 0; background: #000; color: #fff; font-family: 'Orbitron', sans-serif; overflow: hidden; }
        
        /* HUD */
        .hud { position: fixed; top: 0; width: 100%; padding: 15px; display: flex; justify-content: space-between; z-index: 100; pointer-events: none; }
        .stat-card { background: rgba(0,0,0,0.9); border: 1px solid var(--neon); padding: 8px 15px; border-radius: 4px; pointer-events: all; margin-bottom: 5px; box-shadow: 0 0 10px rgba(0,242,255,0.2); }

        .game-layout { display: grid; grid-template-columns: 300px 1fr; height: 100vh; }
        .sidebar { background: #0a0a0a; border-right: 2px solid #222; padding: 15px; z-index: 10; display: flex; flex-direction: column; overflow-y: auto; }
        
        /* Telefon Sistemi */
        #phone { position: fixed; bottom: -450px; right: 30px; width: 240px; height: 450px; background: #111; border: 5px solid #333; border-radius: 35px; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 500; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; }
        #phone.active { bottom: 20px; border-color: var(--pink); }
        .app-btn { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; text-align: center; font-size: 12px; }
        .app-btn:hover { background: var(--pink); }

        /* Market */
        #market-view { display: none; flex-direction: column; gap: 5px; overflow-y: auto; flex: 1; }
        .market-item { background: #222; padding: 8px; border-radius: 5px; font-size: 11px; border-left: 3px solid var(--gold); }

        canvas { width: 100%; height: 100%; }
        #speedo { position: absolute; bottom: 30px; left: 30px; font-size: 35px; color: var(--neon); text-shadow: 0 0 10px var(--neon); }
        .btn-buy { background: var(--gold); color: #000; border: none; padding: 4px; border-radius: 3px; cursor: pointer; font-size: 10px; font-weight: bold; width: 100%; margin-top: 5px; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

<div class="hud">
    <div class="stat-group">
        <div class="stat-card">üí∞ <span id="val-money">500.000</span>‚Ç∫</div>
        <div class="stat-card" style="border-color:var(--gold)">üèéÔ∏è ARA√á: <span id="val-car">Yok</span></div>
    </div>
    <div class="stat-group" style="text-align: right;">
        <div class="stat-card" style="border-color:var(--red)">üî• STRES: %<span id="val-stress">0</span></div>
        <div class="stat-card" style="border-color:var(--pink)">üçî A√áLIK: %<span id="val-hunger">100</span></div>
    </div>
</div>

<div class="game-layout">
    <div class="sidebar">
        <h3 style="color:var(--neon); text-align: center;">TUNA CITY</h3>
        <p style="font-size: 11px; color: #666; text-align: center;">W-A-S-D: S√ºr√º≈ü | P: Telefon</p>
        <hr border="0" style="border-top: 1px solid #333; margin: 15px 0;">
        <div id="npc-actions"></div>
    </div>

    <div style="position: relative; overflow: hidden;">
        <div id="speedo">0 KM/H</div>
        <canvas id="renderCanvas"></canvas>
    </div>
</div>

<div id="phone">
    <div style="text-align: center; margin-bottom: 15px;">
        <div style="width: 40px; height: 4px; background: #333; margin: 0 auto 10px; border-radius: 2px;"></div>
        <span style="font-size: 12px; color: var(--pink);">SAHƒ∞Bƒ∞NDEN TUNAM</span>
    </div>
    
    <div id="market-view">
        </div>

    <div id="home-view">
        <div class="app-btn" onclick="showMarket()">üöó ARA√á PAZARI</div>
        <div class="app-btn" onclick="sellMyCar()" id="sell-btn" style="display: none;">üí∞ ARACIMI SAT</div>
        <div class="app-btn" style="opacity: 0.5;">üí¨ MESAJLAR (0)</div>
    </div>
    
    <button class="app-btn" onclick="togglePhone()" style="margin-top: auto; background: #333;">KAPAT</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    let state = { money: 500000, hunger: 100, stress: 0, car: null };
    const marketCars = [
        {name: "≈ûahin", price: 150000, color: 0xffffff, speed: 0.8},
        {name: "S2000", price: 2200000, color: 0xff0000, speed: 1.4},
        {name: "Supra", price: 5500000, color: 0xffaa00, speed: 1.8},
        {name: "E46 M3", price: 3200000, color: 0x0033ff, speed: 1.5}
    ];

    // --- UI MANTIK ---
    function togglePhone() { document.getElementById('phone').classList.toggle('active'); }
    function showMarket() { 
        document.getElementById('home-view').style.display = 'none';
        const v = document.getElementById('market-view');
        v.style.display = 'flex';
        v.innerHTML = marketCars.map(c => `
            <div class="market-item">
                <b>${c.name}</b> - ${c.price.toLocaleString()}‚Ç∫<br>
                <small>Hƒ±z: ${c.speed*100}</small>
                <button class="btn-buy" onclick="buyCar('${c.name}', ${c.price}, ${c.color}, ${c.speed})">SATIN AL</button>
            </div>
        `).join('');
    }

    function buyCar(name, price, color, speed) {
        if(state.money >= price) {
            state.money -= price;
            state.car = { name, color, speed };
            document.getElementById('val-car').innerText = name;
            document.getElementById('sell-btn').style.display = 'block';
            updateHUD();
            createPlayerCar();
            alert(name + " Hayƒ±rlƒ± olsun kral!");
        } else { alert("Para yetersiz, tefeciye git!"); }
    }

    function sellMyCar() {
        if(!state.car) return;
        let sellPrice = Math.floor(state.car.price || 500000 * 1.2); 
        state.money += sellPrice;
        alert(state.car.name + " aracƒ±nƒ± " + sellPrice.toLocaleString() + "‚Ç∫ fiyata sattƒ±n!");
        state.car = null;
        document.getElementById('val-car').innerText = "Yok";
        document.getElementById('sell-btn').style.display = 'none';
        createPlayerCar();
        updateHUD();
    }

    function updateHUD() {
        document.getElementById('val-money').innerText = state.money.toLocaleString();
        document.getElementById('val-hunger').innerText = Math.floor(state.hunger);
        document.getElementById('val-stress').innerText = Math.floor(state.stress);
    }

    // --- 3D D√úNYA MOTORU ---
    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x000000, 20, 180);
    const camera = new THREE.PerspectiveCamera(75, (window.innerWidth-300)/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('renderCanvas'), antialias: true });
    renderer.setSize(window.innerWidth - 300, window.innerHeight);

    // Yol ve ≈ûeritler
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(2000, 2000), new THREE.MeshStandardMaterial({color: 0x0a0a0a}));
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    for(let i=-50; i<50; i++) {
        // Yol ≈üeritleri
        let line = new THREE.Mesh(new THREE.PlaneGeometry(0.5, 5), new THREE.MeshBasicMaterial({color: 0xffdd00}));
        line.rotation.x = -Math.PI/2;
        line.position.set(0, 0.05, i*15);
        scene.add(line);
        // Sokak Lambalarƒ±
        if(i % 4 === 0) {
            let pole = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 8), new THREE.MeshStandardMaterial({color: 0x333333}));
            pole.position.set(8, 4, i*15);
            let light = new THREE.PointLight(0xffaa00, 2, 20);
            light.position.set(8, 8, i*15);
            scene.add(pole, light);
        }
    }

    // Trafik Ara√ßlarƒ±
    let traffic = [];
    function spawnTraffic() {
        let tCar = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 4), new THREE.MeshStandardMaterial({color: 0x555555}));
        tCar.position.set(Math.random() > 0.5 ? 5 : -5, 0.5, -200 - Math.random()*500);
        scene.add(tCar);
        traffic.push({mesh: tCar, speed: 0.5 + Math.random()});
    }
    for(let i=0; i<15; i++) spawnTraffic();

    // Oyuncu Arabasƒ±
    let player = new THREE.Group();
    scene.add(player);
    function createPlayerCar() {
        player.clear();
        if(!state.car) {
            // Araba yoksa karakter yaya gibi (kutu)
            let box = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({color: 0x00ff00}));
            box.position.y = 1;
            player.add(box);
            return;
        }
        let body = new THREE.Mesh(new THREE.BoxGeometry(2.1, 0.8, 4.2), new THREE.MeshStandardMaterial({color: state.car.color}));
        body.position.y = 0.5;
        let roof = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.5, 1.8), new THREE.MeshStandardMaterial({color: 0x000000}));
        roof.position.set(0, 1, 0.2);
        player.add(body, roof);
        let headL = new THREE.SpotLight(0xffffff, 5, 40, 0.5); headL.position.set(0, 0.5, -2); player.add(headL);
    }
    createPlayerCar();
    scene.add(new THREE.AmbientLight(0xffffff, 0.2));

    // Kontroller
    let keys = {};
    window.onkeydown = (e) => { 
        keys[e.key.toLowerCase()] = true; 
        if(e.key === 'p') togglePhone();
    };
    window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

    let pSpeed = 0, pRot = 0;

    function mainLoop() {
        requestAnimationFrame(mainLoop);
        
        let maxS = state.car ? state.car.speed : 0.2;
        if(keys['w']) pSpeed = Math.min(pSpeed + 0.01, maxS);
        else if(keys['s']) pSpeed = Math.max(pSpeed - 0.02, -0.2);
        else pSpeed *= 0.97;

        if(keys['a']) pRot += 0.04 * (pSpeed > 0 ? 1 : -1);
        if(keys['d']) pRot -= 0.04 * (pSpeed > 0 ? 1 : -1);

        player.rotation.y = pRot;
        player.translateZ(-pSpeed);

        // Trafik Hareket
        traffic.forEach(t => {
            t.mesh.position.z += t.speed;
            if(t.mesh.position.z > 100) t.mesh.position.z = -500;
            // √áarpƒ±≈üma Basit
            if(player.position.distanceTo(t.mesh.position) < 3) {
                state.stress = Math.min(100, state.stress + 5);
                pSpeed = -0.1;
            }
        });

        // Kamera
        let camOffset = new THREE.Vector3(0, 7, 14).applyMatrix4(player.matrixWorld);
        camera.position.lerp(camOffset, 0.1);
        camera.lookAt(player.position);

        document.getElementById('speedo').innerText = Math.abs(Math.floor(pSpeed * 180)) + " KM/H";
        updateHUD();
        renderer.render(scene, camera);
    }

    updateHUD();
    mainLoop();
</script>
</body>
</html>
