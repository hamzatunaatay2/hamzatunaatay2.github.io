<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Galeri Baronu: YeraltÄ±</title>
    <style>
        :root { --neon: #00f2ff; --pink: #ff007f; --gold: #ffd700; --dark: #050505; --panel: #111; }
        body { margin: 0; background: var(--dark); color: #fff; font-family: 'Courier New', monospace; overflow: hidden; user-select: none; }
        
        /* HUD & UI */
        #hud { position: fixed; top: 0; width: 100%; height: 60px; display: flex; align-items: center; justify-content: space-around; background: rgba(0,0,0,0.9); z-index: 1000; border-bottom: 2px solid var(--neon); box-shadow: 0 0 20px var(--neon); }
        .stat { font-size: 18px; font-weight: bold; text-shadow: 0 0 5px var(--neon); cursor: pointer; }
        .stat span { color: var(--gold); }

        /* ANA YAPI */
        #game { display: grid; grid-template-columns: 320px 1fr; height: 100vh; padding-top: 60px; }
        
        /* SOL MENÃœ */
        #sidebar { background: #0a0a0a; border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        .btn { background: #1a1a1a; border: 1px solid #444; color: #fff; padding: 15px; cursor: pointer; transition: 0.3s; font-family: inherit; font-weight: bold; text-align: left; }
        .btn:hover { background: #222; border-color: var(--neon); padding-left: 20px; box-shadow: -5px 0 10px var(--neon); }
        .btn.danger { border-color: var(--pink); color: var(--pink); }
        .btn.danger:hover { background: var(--pink); color: #fff; }

        /* OYUN EKRANI */
        #viewport { position: relative; background: #000; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }
        
        /* OFÄ°S ARAYÃœZÃœ (Overlay) */
        #office-layer { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .dialog-box { background: #fff; color: #000; padding: 20px; border-radius: 2px; width: 80%; max-width: 600px; text-align: center; border: 4px solid var(--neon); position: relative; }
        .dialog-box::after { content: ''; position: absolute; bottom: -20px; left: 50%; border: 10px solid transparent; border-top-color: var(--neon); transform: translateX(-50%); }
        .action-row { margin-top: 30px; display: flex; gap: 10px; }
        
        /* GARAGE LÄ°STESÄ° */
        .car-item { background: #151515; padding: 10px; border-left: 3px solid var(--gold); margin-bottom: 5px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .sell-btn { background: var(--gold); color: #000; border: none; padding: 2px 8px; cursor: pointer; font-weight: bold; }
        
        /* NOTIFICATION */
        #notif { position: fixed; top: 80px; right: -300px; background: var(--pink); color: #fff; padding: 15px; transition: 0.5s; z-index: 2000; font-weight: bold; box-shadow: 5px 5px 0 #fff; }
        #notif.active { right: 20px; }

        /* TELEFON */
        #phone { position: fixed; bottom: -500px; right: 20px; width: 240px; height: 450px; background: #111; border: 5px solid #333; border-radius: 20px; transition: 0.5s; z-index: 1500; padding: 15px; color: #fff; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        #phone.open { bottom: 20px; }
        .app-icon { width: 50px; height: 50px; background: #333; border-radius: 10px; margin: 5px; display: inline-block; text-align: center; line-height: 50px; cursor: pointer; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="hud">
    <div class="stat">ğŸ’µ <span id="money">0</span>â‚º</div>
    <div class="stat">ğŸ‘‘ Ä°tibar: <span id="rep">0</span></div>
    <div class="stat">ğŸ” Enerji: <span id="energy">100</span>%</div>
    <button onclick="saveGame()" style="background:transparent; border:1px solid #444; color:#666; cursor:pointer;">ğŸ’¾ KAYDET</button>
</div>

<div id="game">
    <div id="sidebar">
        <h3 style="color:var(--neon); text-align:center;">OFÄ°S YÃ–NETÄ°MÄ°</h3>
        <button class="btn" onclick="switchMode('office')">ğŸ¤ MÃœÅTERÄ° KABUL</button>
        <button class="btn" onclick="startDrive()">ğŸï¸ ÅEHÄ°R TURU (SÃ¼rÃ¼ÅŸ)</button>
        <button class="btn" onclick="visitImam()">ğŸ•Œ CUMA SOHBETÄ°</button>
        <button class="btn danger" onclick="togglePhone()">ğŸ“± "Ã–ZEL" TELEFON</button>
        
        <hr style="border-color:#333; width:100%">
        <h4 style="color:var(--gold)">GALERÄ° GARAJI</h4>
        <div id="garage-list">
            <div style="color:#666; font-size:12px; padding:10px;">Garaj boÅŸ patron.</div>
        </div>
    </div>

    <div id="viewport">
        <canvas id="stage"></canvas>
        <div id="speedometer" style="position:absolute; bottom:20px; left:20px; font-size:40px; color:var(--neon); font-family:impact; display:none;">0 KM/H</div>

        <div id="office-layer">
            <div style="font-size:100px; margin-bottom:20px;">ğŸ•µï¸</div>
            <div class="dialog-box" id="npc-text">
                "SelamÄ±n aleykÃ¼m reis. Piyasa durgun ama elimde kelepir mal var."
            </div>
            <div class="action-row" id="trade-btns">
                <button class="btn" onclick="processTrade('buy')">AL (Teklifi GÃ¶r)</button>
                <button class="btn danger" onclick="processTrade('kick')">KOV GÄ°TSÄ°N</button>
            </div>
        </div>
    </div>
</div>

<div id="notif">Bildirim MesajÄ±</div>

<div id="phone">
    <div style="text-align:center; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:10px;">
        DOSTCELL 4.5G
    </div>
    <div style="display:flex; flex-wrap:wrap; justify-content:center;">
        <div class="app-icon" onclick="notify('AradÄ±ÄŸÄ±nÄ±z kiÅŸiye ÅŸu an ulaÅŸÄ±lamÄ±yor (Hapiste).')">ğŸ“</div>
        <div class="app-icon" onclick="notify('Kripto borsasÄ± Ã§Ã¶kmÃ¼ÅŸ reis, sonra bak.')">ğŸ“ˆ</div>
        <div class="app-icon" onclick="notify('Yenge: AkÅŸama ekmek al gel.')">ğŸ’¬</div>
        <div class="app-icon" style="background:var(--pink)" onclick="alert('Polis Telsizi: 34. BÃ¶lgede drift ihbarÄ±!')">ğŸš¨</div>
    </div>
    <div style="margin-top:20px; font-size:12px; color:#666; text-align:center;">
        Bakiye: -25.00 TL
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
    // --- OYUN VERÄ°SÄ° ---
    const CAR_MODELS = [
        { name: "TofaÅŸ Åahin S", min: 150000, max: 250000, speed: 0.8 },
        { name: "BMW E30 (Ã‡akal)", min: 400000, max: 600000, speed: 1.2 },
        { name: "Honda S2000", min: 900000, max: 1200000, speed: 1.5 },
        { name: "Passat (AÅŸiret)", min: 1500000, max: 2000000, speed: 1.1 },
        { name: "Mercedes G63", min: 8000000, max: 12000000, speed: 1.3 }
    ];

    let state = {
        money: 500000,
        rep: 10,
        energy: 100,
        garage: [],
        day: 1
    };

    let currentOffer = null;
    let isDriving = false;

    // --- BAÅLANGIÃ‡ ---
    window.onload = function() {
        if(localStorage.getItem('mafiaSave')) {
            state = JSON.parse(localStorage.getItem('mafiaSave'));
            notify("KayÄ±tlÄ± oyun yÃ¼klendi patron.");
        }
        updateUI();
        init3D();
        generateCustomer();
    };

    function saveGame() {
        localStorage.setItem('mafiaSave', JSON.stringify(state));
        notify("Oyun kaydedildi!");
    }

    // --- UI VE MANTIK ---
    function updateUI() {
        document.getElementById('money').innerText = state.money.toLocaleString('tr-TR');
        document.getElementById('rep').innerText = state.rep;
        document.getElementById('energy').innerText = Math.floor(state.energy);

        const list = document.getElementById('garage-list');
        list.innerHTML = "";
        if(state.garage.length === 0) list.innerHTML = "<div style='padding:10px; color:#444'>Garaj boÅŸ.</div>";
        
        state.garage.forEach((car, idx) => {
            let val = Math.floor(car.boughtPrice * (1.1 + (Math.random()*0.2))); // %10-%30 kÃ¢r potansiyeli
            list.innerHTML += `
            <div class="car-item">
                <div>
                    <div style="color:#fff; font-weight:bold;">${car.name}</div>
                    <div style="color:#666;">AlÄ±ÅŸ: ${car.boughtPrice.toLocaleString()}â‚º</div>
                </div>
                <button class="sell-btn" onclick="sellCar(${idx})">SAT</button>
            </div>`;
        });
    }

    function notify(msg) {
        const n = document.getElementById('notif');
        n.innerText = msg;
        n.classList.add('active');
        setTimeout(() => n.classList.remove('active'), 3000);
    }

    function switchMode(mode) {
        if(mode === 'office') {
            document.getElementById('office-layer').classList.remove('hidden');
            document.getElementById('speedometer').style.display = 'none';
            isDriving = false;
            generateCustomer();
        } else if (mode === 'drive') {
            if(state.garage.length === 0) {
                notify("Araban yok ki neyi sÃ¼receksin?");
                return;
            }
            document.getElementById('office-layer').classList.add('hidden');
            document.getElementById('speedometer').style.display = 'block';
            isDriving = true;
            resetCarPosition();
        }
    }

    // --- TÄ°CARET SÄ°STEMÄ° ---
    function generateCustomer() {
        const carBase = CAR_MODELS[Math.floor(Math.random() * CAR_MODELS.length)];
        // Fiyat varyasyonu
        const price = Math.floor(Math.random() * (carBase.max - carBase.min) + carBase.min);
        
        currentOffer = { name: carBase.name, price: price, data: carBase };
        
        const dialogs = [
            `"Usta ${currentOffer.
